name: Build SDRSharp Rtl_433 Plugin

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1. Checkout du plugin
      - name: Checkout plugin
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      ###############################################
      # 2. Build SDRSharp.Rtl_433.dll en x86
      ###############################################
      - name: Build plugin x86
        run: |
          msbuild Rtl_433_Plugin\SDRSharp.Rtl_433_Plugin.csproj `
            /p:Configuration=CI_x86 `
            /p:Platform="x86"

      ###############################################
      # 3. Build SDRSharp.Rtl_433.dll en x64
      ###############################################
      - name: Build plugin x64
        run: |
          msbuild Rtl_433_Plugin\SDRSharp.Rtl_433_Plugin.csproj `
            /p:Configuration=CI_x64 `
            /p:Platform="x64"

      ###############################################
      # 4. Télécharger artefacts rtl_433 (x86 + x64)
      ###############################################
      - name: Download rtl_433 artifacts
        uses: actions/download-artifact@v4
        with:
          path: rtl_433_artifacts

      ###############################################
      # 5. Télécharger artefacts GraphLib (x86 + x64)
      ###############################################
      - name: Download GraphLib artifacts
        uses: actions/download-artifact@v4
        with:
          path: graphlib_artifacts

      ###############################################
      # 6. Assemblage des DLL x86
      ###############################################
      - name: Assemble x86 package
        run: |
          mkdir plugin_x86
          copy bin\x86\CI_x86\SDRSharp.Rtl_433.dll plugin_x86\
          copy rtl_433_artifacts\CI_x86\*.dll plugin_x86\
          copy graphlib_artifacts\CI_x86\*.dll plugin_x86\

      ###############################################
      # 7. Assemblage des DLL x64
      ###############################################
      - name: Assemble x64 package
        run: |
          mkdir plugin_x64
          copy bin\x64\CI_x64\SDRSharp.Rtl_433.dll plugin_x64\
          copy rtl_433_artifacts\CI_x64\*.dll plugin_x64\
          copy graphlib_artifacts\CI_x64\*.dll plugin_x64\

      ###############################################
      # 8. Création des ZIP finaux
      ###############################################
      - name: Create ZIPs
        run: |
          powershell Compress-Archive -Path plugin_x86 -DestinationPath plugin_rtl433-x86.zip
          powershell Compress-Archive -Path plugin_x64 -DestinationPath plugin_rtl433-x64.zip

      ###############################################
      # 9. Upload des ZIP finaux
      ###############################################
      - name: Upload x86 ZIP
        uses: actions/upload-artifact@v4
        with:
          name: plugin_rtl433_x86
          path: plugin_rtl433-x86.zip

      - name: Upload x64 ZIP
        uses: actions/upload-artifact@v4
        with:
          name: plugin_rtl433_x64
          path: plugin_rtl433-x64.zip